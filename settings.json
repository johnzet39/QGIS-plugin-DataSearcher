{
    "Layers": {
        "Рекламные конструкции": {
            "columns_count": 3,
            "column_key": "gid",
            "fields" : {
                "land_owner_id": {
                    "label": "Собственник",
                    "source_type": "postgres",
                    "query_data": "select id, owner from schema_reklama.v_spr_persons_firms order by owner",
                    "field_key": "id",
                    "field_title": "owner",
                    "minmax_size": [100, 3000]
                },
                "kind_id": {
                    "label": "Вид",
                    "source_type": "own",
                    "col_span": 1
                },  
                "isschema": {
                    "label": "В схеме",
                    "source_type": "custom",
                    "field_type": "CheckBox"
                },             
                "street_id": {
                    "label": "Улица",
                    "source_type": "own"
                },
                "perm_code": {
                    "label": "Номер разрешения",
                    "source_type": "custom",
                    "field_type": "RangeInt"
                },
                "perm_date": {
                    "label": "Пер.дейст.разр.",
                    "source_type": "custom",
                    "field_type": "DateTime",
                    "isrange": "True"
                },
                "contr_code": {
                    "label": "Номер договора",
                    "source_type": "custom",
                    "field_type": "RangeInt"
                },
                "contr_date": {
                    "label": "Пер.дейст.дог.",
                    "source_type": "custom",
                    "field_type": "DateTime",
                    "isrange": "True"
                },
                "gid": {
                    "label": "гид",
                    "source_type": "custom",
                    "field_type": "RangeInt",
                    "col_span": 1
                },
                "archive": {
                    "label": "Актуальность",
                    "source_type": "custom",
                    "field_type": "ComboBox",
                    "combobox_values": {
                        "": "Все",
                        "1": "Архивные",
                        "0": "Действующие"
                    }
                },
                "issued": {
                    "label": "Паспорт выдан",
                    "source_type": "custom",
                    "field_type": "ComboBox",
                    "combobox_values": {
                        "": "Все",
                        "-1": "Выдан",
                        "0": "Не выдан"
                    }
                },
                "zone_id": {
                    "label": "Номер зоны",
                    "source_type": "layer",
                    "layer_name": "spr_zones",
                    "field_key": "id",
                    "field_title": "zonename"
                }
                
            },
            "query": [
                " with zone_default as (SELECT id, zonename||' (auto)' as zonename  from schema_reklama.spr_zones where isdefault=true limit 1) ",
                " select ",
                " case when g.archive = 1 then 'АРХИВ' end as \"АК\", ",
                " g.gid, k.title as \"Вид\", ",
                " s.name as \"Улица\", g.postnum as \"Дом\", ", 
                " case when z.zonename is not null then z.zonename else (select zonename from zone_default) end as \"Номер зоны\", ",
                " p.code as \"Номер разрешения\", case when p.archive = 1 then 'A' end as \"АР\", p.start_date as \"Дата разр.\", p.end_date as \"Конец разр.\", p.issued as \"Выдан\", ",
                " p.code as \"Номер договора\", case when p.archive = 1 then 'A' end as \"АД\", cntr.start_date as \"Дата дог.\", cntr.end_date as \"Конец дог.\", ", 
                " loi.owner as \"Собственник\" ",
                
                " ",
                " FROM schema_reklama.geo_ad_constructions g ",
                " LEFT JOIN schema_reklama.ad_permissions p ON p.construction_id = g.gid ",
                " LEFT JOIN schema_reklama.ad_contracts cntr ON cntr.construction_id = g.gid ",
                " LEFT JOIN schema_reklama.spr_ad_kind k ON k.id = g.kind_id ",
                " LEFT JOIN schema_reklama.v_spr_persons_firms loi ON loi.id = g.land_owner_id ",
                " LEFT JOIN schema_reklama.ad_zones_streets zs ON g.street_id = zs.street_sys ",
                " LEFT JOIN schema_reklama.spr_zones z ON z.id = zs.zone_id ",
                " LEFT JOIN schema_spr.spr_streets s ON s.SYSUL = g.street_id ",

                " WHERE ",
                " (%(gid)s is null OR g.gid = %(gid)s) ",
                " AND (%(land_owner_id)s is null OR loi.id = %(land_owner_id)s) ",
                " AND (%(kind_id)s is null OR k.id = %(kind_id)s) ",
                " AND (%(isschema)s is null OR k.isschema = %(isschema)s) ",
                " AND (%(street_id)s is null OR g.street_id = %(street_id)s) ",
                " AND (%(perm_code)s is null OR p.code = %(perm_code)s) ",
                " AND (%(issued)s is null OR p.issued = %(issued)s) ",
                " AND (%(perm_date_from)s is null OR p.start_date >= %(perm_date_from)s) ",
                " AND (%(perm_date_to)s is null OR p.end_date < %(perm_date_to)s) ",
                " AND (%(archive)s is null OR g.archive = %(archive)s) ",
                " AND (%(zone_id)s is null OR CASE WHEN %(zone_id)s = (select id from zone_default)  THEN z.id=4 OR z.id is NULL else z.id = %(zone_id)s END)"
            ]
            
        },
        "spr_ad_kind": {
            "columns_count": 3,
            "column_key": "id",
            "fields" : {
                "id": {
                    "label": "id",
                    "source_type": "own"
                },
                "title": {
                    "label": "title",
                    "source_type": "own"
                }
            },
            "query": [
                "select k.id, k.title from schema_reklama.spr_ad_kind k",
                " WHERE (%(id)s is null OR k.id = %(id)s) ", 
                " AND (%(title)s is null OR lower(k.title) ilike %(title)s) "
            ]
            
        }
    }
}