{
    "Layers": {
        "Рекламные конструкции": {
            "columns_count": 4,
            "column_key": "gid",
            "fields" : {
                "land_owner_id": {
                    "label": "Собственник",
                    "source_type": "postgres",
                    "query_data": "select id, owner from schema_reklama.v_spr_persons_firms order by owner",
                    "field_key": "id",
                    "field_title": "owner",
                    "minmax_size": [100, 3000],
                    "col_span": 2
                },
                "kind_id": {
                    "label": "Вид",
                    "source_type": "own",
                    "col_span": 1
                },          
                "street_id": {
                    "label": "Улица",
                    "source_type": "own"
                },
                "zone_id": {
                    "label": "Номер зоны",
                    "source_type": "layer",
                    "layer_name": "spr_zones",
                    "field_key": "id",
                    "field_title": "zonename"
                },
                "perm_code": {
                    "label": "Номер разрешения",
                    "source_type": "custom",
                    "field_type": "RangeInt"
                },
                "perm_date": {
                    "label": "Период разрешения",
                    "source_type": "custom",
                    "field_type": "DateTime",
                    "isrange": "True"
                },
                "issued": {
                    "label": "Разр. выдано",
                    "source_type": "custom",
                    "field_type": "ComboBox",
                    "combobox_values": {
                        "": "Все",
                        "-1": "Выдан",
                        "0": "Не выдан"
                    }
                },
                "contr_code": {
                    "label": "Номер договора",
                    "source_type": "custom",
                    "field_type": "RangeInt"
                },
                "contr_date": {
                    "label": "Период договора",
                    "source_type": "custom",
                    "field_type": "DateTime",
                    "isrange": "True"
                },
                "__2": {},
                "__3": {},
                "archive": {
                    "label": "Актуальность",
                    "source_type": "custom",
                    "field_type": "ComboBox",
                    "combobox_values": {
                        "": "Все",
                        "1": "Архивные",
                        "0": "Действующие"
                    }
                },
                "isschema": {
                    "label": "В схеме",
                    "source_type": "custom",
                    "field_type": "CheckBox"
                },
                "gid": {
                    "label": "гид",
                    "source_type": "custom",
                    "field_type": "RangeInt",
                    "col_span": 1
                }
                
            },
            "query": [
                " with zone_default as (SELECT id, zonename||' (auto)' as zonename  from schema_reklama.spr_zones where isdefault=true limit 1) ",
                " select ",
                " case when g.archive = 1 then 'АРХИВ' end as \"АК\", ",
                " g.gid, k.title as \"Вид\", ",
                " s.name as \"Улица\", g.postnum as \"Дом\", ", 
                " case when z.zonename is not null then z.zonename else (select zonename from zone_default) end as \"Номер зоны\", ",
                " p.code as \"Номер разрешения\", case when p.archive = 1 then 'A' end as \"АР\", p.start_date as \"Дата разр.\", p.end_date as \"Конец разр.\", p.issued as \"Выдан\", ",
                " cntr.code as \"Номер договора\", case when cntr.archive = 1 then 'A' end as \"АД\", cntr.start_date as \"Дата дог.\", cntr.end_date as \"Конец дог.\", ", 
                " loi.owner as \"Собственник\" ",
                
                " ",
                " FROM schema_reklama.geo_ad_constructions g ",
                " LEFT JOIN schema_reklama.ad_permissions p ON p.construction_id = g.gid ",
                " LEFT JOIN schema_reklama.ad_contracts cntr ON cntr.construction_id = g.gid ",
                " LEFT JOIN schema_reklama.spr_ad_kind k ON k.id = g.kind_id ",
                " LEFT JOIN schema_reklama.v_spr_persons_firms loi ON loi.id = g.land_owner_id ",
                " LEFT JOIN schema_reklama.ad_zones_streets zs ON g.street_id = zs.street_sys ",
                " LEFT JOIN schema_reklama.spr_zones z ON z.id = zs.zone_id ",
                " LEFT JOIN schema_spr.spr_streets s ON s.SYSUL = g.street_id ",

                " WHERE ",
                " (%(gid)s is null OR g.gid = %(gid)s) ",
                " AND (%(land_owner_id)s is null OR loi.id = %(land_owner_id)s) ",
                " AND (%(kind_id)s is null OR k.id = %(kind_id)s) ",
                " AND (%(isschema)s is null OR k.isschema = %(isschema)s) ",
                " AND (%(street_id)s is null OR g.street_id = %(street_id)s) ",
                " AND (%(perm_code)s is null OR p.code = %(perm_code)s) ",
                " AND (%(contr_code)s is null OR cntr.code = %(contr_code)s) ",
                " AND (%(issued)s is null OR p.issued = %(issued)s) ",
                " AND (%(perm_date_from)s is null OR p.start_date >= %(perm_date_from)s) ",
                " AND (%(contr_date_from)s is null OR cntr.start_date >= %(contr_date_from)s) ",
                " AND (%(perm_date_to)s is null OR p.end_date < %(perm_date_to)s) ",
                " AND (%(contr_date_to)s is null OR cntr.end_date < %(contr_date_to)s) ",
                " AND (%(archive)s is null OR g.archive = %(archive)s) ",
                " AND (%(zone_id)s is null OR CASE WHEN %(zone_id)s = (select id from zone_default)  THEN z.id=4 OR z.id is NULL else z.id = %(zone_id)s END)"
            ]
            
        },
        "Контейнерные площадки     •": {
            "columns_count": 3,
            "column_key": "gid",
            "fields" : {
                "num_reestr": {
                    "label": "Реестровый номер",
                    "source_type": "own"
                },
                "street_id": {
                    "label": "Улица",
                    "source_type": "own"
                },
                "area_tko": {
                    "label": "Площадь",
                    "source_type": "own",
                    "isrange": "True"
                },
                "volume": {
                    "label": "Общий объем",
                    "source_type": "custom",
                    "field_type": "rangefloat",
                    "isrange": "True"
                },
                "c_count": {
                    "label": "Всего контейнеров",
                    "source_type": "custom",
                    "field_type": "rangeint",
                    "isrange": "True"
                },
                "comments": {
                    "label": "Комментарии",
                    "source_type": "own"
                },
                "type_id": {
                    "label": "Тип контейнеров",
                    "source_type": "custom",
                    "field_type": "ComboBox",
                    "combobox_values": {
                        "": "",
                        "1": "Куб",
                        "2": "Кеска"
                    }
                },
                "condition_id": {
                    "label": "Состояние",
                    "source_type": "custom",
                    "field_type": "ComboBox",
                    "combobox_values": {
                        "": "",
                        "1": "Исправен",
                        "2": "Требует замены"
                    }
                }
            },
            "query": [
                " select gid, num_reestr as \"Реестровый номер\", streetname as \"Улица\", postnum as \"Дом\", area_tko as \"Площадь площадки\", ", 
                "        vol as \"Общий объем\", c_count as \"Всего контейнеров\",  string_agg(type_cond, ',') as \"Тип\", ",
                " comments as \"Комментарии\"  ", 
                " from ",

                "(select  ",
                "   t.gid, t.num_reestr , str.name as streetname, t.postnum, t.area_tko, ",
                "   (select coalesce(sum(sc.volume), 0) from schema_spr.spr_tko_containers sc where sc.geo_tko_gid = t.gid) as vol, ",
                "   (select coalesce(count(*), 0) from schema_spr.spr_tko_containers sc where sc.geo_tko_gid = t.gid) as c_count, ",
                "   case when sc.type_id = 1 then 'Куб' when sc.type_id = 2 then 'Кеска' end  || case when sc.condition_id=1 then '(OK)' when sc.condition_id=2 then '(X)' else '' end as type_cond, ",
                "   ",
                "   t.comments",
                "   from geo_tko t ", 
                "   LEFT JOIN schema_spr.spr_tko_containers sc ON sc.geo_tko_gid = t.gid",
                "   LEFT JOIN schema_spr.spr_streets str ON str.sysul = t.street_id",
                "   where ",
                "   (%(num_reestr)s is null OR t.num_reestr = %(num_reestr)s) ",
                "   AND (%(street_id)s is null OR t.street_id = %(street_id)s) ",
                "   AND (%(area_tko_from)s is null OR t.area_tko >= %(area_tko_from)s) ",
                "   AND (%(area_tko_to)s is null OR t.area_tko <= %(area_tko_to)s) ",
                "   AND (%(volume_from)s is null OR (select coalesce(sum(sc.volume), 0) from schema_spr.spr_tko_containers sc where sc.geo_tko_gid = t.gid) >= %(volume_from)s) ",
                "   AND (%(volume_to)s is null OR (select coalesce(sum(sc.volume), 0) from schema_spr.spr_tko_containers sc where sc.geo_tko_gid = t.gid) <= %(volume_to)s) ",
                "   AND (%(c_count_from)s is null OR (select coalesce(count(*), 0) from schema_spr.spr_tko_containers sc where sc.geo_tko_gid = t.gid) >= %(c_count_from)s) ",
                "   AND (%(c_count_to)s is null OR (select coalesce(count(*), 0) from schema_spr.spr_tko_containers sc where sc.geo_tko_gid = t.gid) <= %(c_count_to)s) ",
                "   AND (%(comments)s is null OR t.comments ilike %(comments)s) ",
                "   AND (%(type_id)s is null OR sc.type_id = %(type_id)s) ",
                "   AND (%(condition_id)s is null OR sc.condition_id = %(condition_id)s) ",
                " ) s",

                " group by gid, num_reestr, streetname, postnum, area_tko, vol, c_count, comments"
            ]

        }
    }
}